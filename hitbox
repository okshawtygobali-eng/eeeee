-- [[ AXIOS HITBOX CORE - VERSION 2.1 ]]
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer

local LimbExtender = {}
LimbExtender.__index = LimbExtender

-- Settings Template
local DEFAULTS = {
    TARGET_LIMB = "HumanoidRootPart",
    LIMB_SIZE = 5,
    LIMB_TRANSPARENCY = 0.5,
    LIMB_CAN_COLLIDE = false,
    TEAM_CHECK = false,
}

-- Standard Initialization (Fixes the "Table Value" error)
function LimbExtender.new(userSettings)
    local self = setmetatable({}, LimbExtender)
    self._settings = userSettings or DEFAULTS
    self._running = false
    self._connections = {}
    self._spoofTable = setmetatable({}, { __mode = "k" })
    
    -- Anti-Cheat Bypass Safety Check (Fixes the "Nil Value" error)
    local grm = getrawmetatable or nil
    local sro = setreadonly or make_writeable or nil
    
    if grm and sro then
        pcall(function()
            local mt = grm(game)
            local oldIndex = mt.__index
            if setreadonly then setreadonly(mt, false) else make_writeable(mt) end
            mt.__index = function(obj, key)
                if key == "Size" and not checkcaller() and self._spoofTable[obj] then
                    return self._spoofTable[obj]
                end
                return oldIndex(obj, key)
            end
            if setreadonly then setreadonly(mt, true) else make_readonly(mt) end
        end)
    end
    return self
end

-- Physics Fix: Prevents players from freezing or getting stuck
function LimbExtender:Modify(char)
    if not char or not self._running then return end
    
    task.spawn(function()
        local part = char:WaitForChild(self._settings.TARGET_LIMB, 5)
        if part and part:IsA("BasePart") then
            -- Save real size for spoofing
            self._spoofTable[part] = part.Size
            
            -- Set size with Wall Shape math
            local size = self._settings.LIMB_SIZE
            part.Size = Vector3.new(size, size, size / 1.25)
            
            -- [[ MANDATORY PHYSICS OVERRIDE ]]
            part.CanCollide = false -- Prevents floor clipping
            part.Massless = true   -- Prevents weight freezing
            part.Transparency = self._settings.LIMB_TRANSPARENCY
        end
    end)
end

function LimbExtender:Start()
    if self._running then return end
    self._running = true
    local function setup(plr)
        if plr == localPlayer then return end
        plr.CharacterAdded:Connect(function(c) 
            task.wait(0.2) -- Safety delay for physics
            self:Modify(c) 
        end)
        if plr.Character then self:Modify(plr.Character) end
    end
    table.insert(self._connections, Players.PlayerAdded:Connect(setup))
    for _, p in ipairs(Players:GetPlayers()) do setup(p) end
end

function LimbExtender:Stop()
    self._running = false
    for _, v in ipairs(self._connections) do v:Disconnect() end
    self._connections = {}
    for part in pairs(self._spoofTable) do self._spoofTable[part] = nil end
end

function LimbExtender:Get(k) return self._settings[k] end
function LimbExtender:Set(k, v) self._settings[k] = v end
function LimbExtender:Toggle(v) if v then self:Start() else self:Stop() end end

-- Explicitly return the table
return LimbExtender
