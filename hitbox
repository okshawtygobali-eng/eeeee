-- [[ OPTIMIZED HITBOX EXPANDER - BAREBONES EDITION ]]
-- Focus: Raw Performance, Low Memory, FPS Stability.
-- Features: Size Enforcement, Toggle (L), No visual bloat.

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- [[ CONFIGURATION ]]
local SETTINGS = {
	TOGGLE_KEY = Enum.KeyCode.L,
	TARGET_PART = "HumanoidRootPart",
	SIZE = Vector3.new(15, 15, 15),
	TRANSPARENCY = 0.9,
	CAN_COLLIDE = false,
}

-- [[ GLOBAL STATE MANAGEMENT ]]
-- Ensures re-executing the script cleans up the previous instance to prevent memory leaks.
local Data = getgenv().HitboxOptimized
if Data and Data.Cleanup then
	Data.Cleanup()
end

Data = {
	Connections = {}, -- Stores raw RBXScriptConnections
	Limbs = {},       -- Stores original properties for restoring
	Running = false,
}
getgenv().HitboxOptimized = Data

-- [[ HELPER FUNCTIONS ]]

local function RestoreLimb(part)
	if not part then return end
	local original = Data.Limbs[part]
	if original then
		part.Size = original.Size
		part.Transparency = original.Transparency
		part.CanCollide = original.CanCollide
		Data.Limbs[part] = nil
	end
end

local function EnforceProperties(part)
	if not part or not Data.Running then return end
	
	-- Force properties
	if part.Size ~= SETTINGS.SIZE then part.Size = SETTINGS.SIZE end
	if part.Transparency ~= SETTINGS.TRANSPARENCY then part.Transparency = SETTINGS.TRANSPARENCY end
	if part.CanCollide ~= SETTINGS.CAN_COLLIDE then part.CanCollide = SETTINGS.CAN_COLLIDE end
end

local function HookPart(part)
	if not part or Data.Limbs[part] then return end -- Already hooked
	
	-- Save original state (Memory Friendly: Only simple Vector3/Numbers)
	Data.Limbs[part] = {
		Size = part.Size,
		Transparency = part.Transparency,
		CanCollide = part.CanCollide
	}

	-- Apply immediately
	EnforceProperties(part)

	-- [[ OPTIMIZATION: Single Signal Connection ]]
	-- We only watch "Size" because that's what games usually fight back against.
	-- We re-apply all properties if Size changes to save Connection memory.
	local conn = part:GetPropertyChangedSignal("Size"):Connect(function()
		if Data.Running then
			EnforceProperties(part)
		end
	end)
	
	table.insert(Data.Connections, conn)
end

local function SetupCharacter(char)
	if not char then return end
	
	-- Wait for the part briefly, but don't hang forever (Memory safety)
	local part = char:WaitForChild(SETTINGS.TARGET_PART, 5)
	if part then
		HookPart(part)
	end
end

local function SetupPlayer(plr)
	if plr == LocalPlayer then return end -- Skip self

	-- Handle current character
	if plr.Character then
		task.spawn(SetupCharacter, plr.Character)
	end

	-- Handle future characters (Respawn)
	local conn = plr.CharacterAdded:Connect(function(char)
		-- Small delay to ensure geometry is ready
		task.delay(0.2, SetupCharacter, char)
	end)
	table.insert(Data.Connections, conn)
end

-- [[ CORE FUNCTIONS ]]

local function Start()
	if Data.Running then return end
	Data.Running = true
	
	-- Connect to existing players
	for _, plr in ipairs(Players:GetPlayers()) do
		SetupPlayer(plr)
	end

	-- Connect to future players (Join)
	local conn = Players.PlayerAdded:Connect(SetupPlayer)
	table.insert(Data.Connections, conn)
	
	print("[Hitbox] Enabled")
end

local function Stop()
	Data.Running = false
	
	-- clear connections
	for _, conn in ipairs(Data.Connections) do
		if conn.Connected then conn:Disconnect() end
	end
	table.clear(Data.Connections)

	-- restore parts
	for part, _ in pairs(Data.Limbs) do
		RestoreLimb(part)
	end
	table.clear(Data.Limbs)
	
	print("[Hitbox] Disabled")
end

local function Toggle()
	if Data.Running then
		Stop()
	else
		Start()
	end
end

-- [[ INPUT HANDLING ]]
local inputConn = UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if not gameProcessed and input.KeyCode == SETTINGS.TOGGLE_KEY then
		Toggle()
	end
end)
table.insert(Data.Connections, inputConn)

-- [[ CLEANUP EXPORT ]]
Data.Cleanup = function()
	Stop()
	if inputConn.Connected then inputConn:Disconnect() end
	getgenv().HitboxOptimized = nil
end

-- Initialize
Start()
