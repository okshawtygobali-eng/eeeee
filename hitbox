local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

-- [[ HARD-CODED SETTINGS ]]
local TARGET_LIMB = "HumanoidRootPart"
local LIMB_SIZE = 5
local LIMB_TRANSPARENCY = 0.5
local WALL_THICKNESS_DIVISOR = 1.25 -- This makes the Z-axis 4 studs if size is 5
local TOGGLE_KEY = Enum.KeyCode.L

local limbExtenderData = getgenv().limbExtenderData or {}
getgenv().limbExtenderData = limbExtenderData
limbExtenderData.Running = limbExtenderData.Running or false
limbExtenderData.SpoofedParts = limbExtenderData.SpoofedParts or setmetatable({}, { __mode = "k" })

-- [[ ONE-TIME PERFORMANCE BYPASS ]]
-- Wrapped in a safety check to prevent the "nil value" error on your executor
if not limbExtenderData.HookInstalled then
    local grm = getrawmetatable or nil
    local sro = setreadonly or make_writeable or nil
    if grm and sro then
        local mt = grm(game)
        if setreadonly then setreadonly(mt, false) else make_writeable(mt) end
        local oldIndex = mt.__index
        mt.__index = function(self, key)
            if key == "Size" and not checkcaller() then
                local savedSize = limbExtenderData.SpoofedParts[self]
                if savedSize then return savedSize end
            end
            return oldIndex(self, key)
        end
        if setreadonly then setreadonly(mt, true) else make_readonly(mt) end
        limbExtenderData.HookInstalled = true
    end
end

-- [[ CORE FUNCTIONS ]]
local function modifyLimb(part)
    if not part or not part:IsA("BasePart") then return end
    
    -- Save original size so we can spoof it (hide it from anti-cheat)
    limbExtenderData.SpoofedParts[part] = part.Size
    
    -- Apply "Wall" shape: (5, 5, 4)
    local newSize = Vector3.new(LIMB_SIZE, LIMB_SIZE, LIMB_SIZE / WALL_THICKNESS_DIVISOR)
    
    part.Size = newSize
    part.Transparency = LIMB_TRANSPARENCY
    part.CanCollide = false
    part.Massless = true
end

local function setupCharacter(char)
    if not char then return end
    local root = char:WaitForChild(TARGET_LIMB, 5)
    if root and limbExtenderData.Running then
        modifyLimb(root)
    end
end

-- [[ TOGGLE LOGIC ]]
local function toggle()
    limbExtenderData.Running = not limbExtenderData.Running
    print("Hitbox Expander: " .. (limbExtenderData.Running and "ON" or "OFF"))
    
    if limbExtenderData.Running then
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= localPlayer and plr.Character then
                setupCharacter(plr.Character)
            end
        end
    else
        -- Clean up: Refreshing characters usually resets parts naturally
        -- but we clear the spoof table to be safe
        for part in pairs(limbExtenderData.SpoofedParts) do
            limbExtenderData.SpoofedParts[part] = nil
        end
    end
end

-- Listen for the 'L' key to turn it on/off
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == TOGGLE_KEY then
        toggle()
    end
end)

-- Watch for new players or respawns
Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(setupCharacter)
end)

for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= localPlayer then
        plr.CharacterAdded:Connect(setupCharacter)
        if plr.Character then setupCharacter(plr.Character) end
    end
end

print("Limb Extender Loaded. Press 'L' to Toggle.")
